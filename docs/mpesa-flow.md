# M-Pesa donation and payout flow

## 1. Donor checkout and STK push initiation
1. The web app invokes the `requestStkPush` GraphQL mutation after basic auth, rate-limit, and profile checks succeed. The resolver passes the donor, submission, amount, MSISDN, and idempotency key into the donation request service with the current request logger. 【F:apps/api/src/donations/donation.resolver.ts†L13-L39】【F:apps/api/src/donations/services/donation-requests.service.ts†L35-L126】
2. `DonationRequestsService.requestStkPush` validates the payload: positive whole-shilling amounts, normalized MSISDNs, sanitized account references/descriptions, and a SHA-256 idempotency hash to dedupe repeats. If the hash already exists, the existing donation snapshot is returned. 【F:apps/api/src/donations/services/donation-requests.service.ts†L128-L262】
3. A new donation document is created with pending status, base status history, and the normalized account reference before the STK push is attempted. 【F:apps/api/src/donations/services/donation-requests.service.ts†L264-L326】
4. The service calls `DarajaClient.requestStkPush`, logging request metadata to aid traceability. 【F:apps/api/src/donations/services/donation-requests.service.ts†L328-L380】【F:apps/api/src/mpesa/daraja.client.ts†L141-L155】

## 2. Daraja STK push implementation details
1. `DarajaClient` centralizes configuration for environment base URLs, consumer credentials, short code, passkey, and callback URL, encrypting the consumer key/secret using AES-GCM and caching the encrypted blob. Missing configuration fails fast. 【F:apps/api/src/mpesa/daraja.client.ts†L68-L139】
2. Every STK push call computes the Daraja password (`Base64(shortCode + passkey + timestamp)`), supplies the documented payload fields, and retries transient failures with exponential backoff. 【F:apps/api/src/mpesa/daraja.client.ts†L157-L199】
3. Access tokens are fetched from `/oauth/v1/generate?grant_type=client_credentials`, decrypted on demand, cached with a one-minute safety margin, and refreshed when expired. 【F:apps/api/src/mpesa/daraja.client.ts†L217-L239】
4. Successful responses update the donation with the returned `CheckoutRequestID`, `MerchantRequestID`, response description, and status history; failures mark the donation failed with the error message. 【F:apps/api/src/donations/services/donation-requests.service.ts†L204-L276】

**Daraja parity check.** Safaricom Daraja’s STK push specification requires the exact fields emitted here: `BusinessShortCode`, computed `Password`, `Timestamp`, `TransactionType="CustomerPayBillOnline"`, `Amount`, `PartyA/PartyB`, `PhoneNumber`, `CallBackURL`, `AccountReference`, and `TransactionDesc`. The client also honours the OAuth flow, short code credential checks, and retry/backoff guidance from the public API docs. The main configuration prerequisite is supplying the production callback URL and webhook public certificate in environment variables.

## 3. Webhook intake and signature verification
1. Safaricom’s callback posts to `POST /webhooks/mpesa/stkpush`. The controller captures the raw body, verifies the RSA signature + timestamp tolerance, and persists a webhook event record (including headers and verification result) for auditing. 【F:apps/api/src/webhooks/mpesa.controller.ts†L27-L57】
2. Invalid signatures are logged, written to the audit log with reasons, and rejected with HTTP 400 so the upstream can retry. Valid payloads are enqueued for asynchronous processing together with metadata (request id, source IP). 【F:apps/api/src/webhooks/mpesa.controller.ts†L70-L121】
3. `MpesaSignatureService` enforces required headers, configurable skew tolerance, and RSA-SHA256 validation against the configured Safaricom public certificate. Failures emit structured logs that highlight missing headers, stale timestamps, or signature mismatches. 【F:apps/api/src/webhooks/mpesa-signature.service.ts†L21-L100】
4. The BullMQ-backed `MpesaCallbackQueue` spins up when Redis is available, dispatching jobs to `DonationService.processStkPushCallback` with retries and falling back to inline execution if the queue is disabled (tests) or unavailable. 【F:apps/api/src/webhooks/mpesa-callback.queue.ts†L25-L136】

## 4. Donation state transitions after a callback
1. Callbacks are parsed to extract checkout IDs, metadata items (amount, receipt, phone, transaction date, account reference), and result codes. Unknown payloads are ignored but logged and audited. 【F:apps/api/src/donations/services/donation-callback.service.ts†L154-L239】
2. Processing happens inside a MongoDB transaction to guarantee atomic updates. A missing donation is audited and ignored; existing donations are updated unless the message is an idempotent replay (matching amount/receipt/status). 【F:apps/api/src/donations/services/donation-callback.service.ts†L194-L333】
3. Each processed callback records an audit event, redacts sensitive fields for logs, and exposes helpers to mask MSISDNs before logging. 【F:apps/api/src/donations/services/donation-callback.service.ts†L334-L431】
4. The donation schema enforces a unique `mpesaCheckoutRequestId`, stores receipts, payer phones, raw payloads, and timestamps so downstream ledgers and reconciliation can cross-reference Safaricom artifacts. 【F:apps/api/src/donations/donation.schema.ts†L13-L59】

## 5. Creator payout lifecycle
1. Once donations clear (`status=paid`), the payouts subsystem surfaces them to creators with payout states (`unassigned` → `scheduled` → `processing` → `paid/failed`) alongside donation metadata and availability dates. 【F:apps/api/src/payouts/schemas/donation.schema.ts†L14-L53】【F:apps/api/src/payouts/models/donation-payout-state.enum.ts†L1-L10】
2. `PayoutsService.listCreatorDonations` implements cursor-based pagination, aggregates lifetime/pending/available totals, and prepares 14-day trend points so creators can monitor progress toward payouts. 【F:apps/api/src/payouts/payouts.service.ts†L20-L199】
3. Scheduled payout batches capture grouped transfers with status tracking and totals, exposed through GraphQL connections for creators to review. 【F:apps/api/src/payouts/schemas/payout-batch.schema.ts†L1-L33】【F:apps/api/src/payouts/payouts.service.ts†L200-L272】
4. Payout notifications summarize state changes (scheduled, processing, paid, failed) and support marking items read, helping creators stay informed. 【F:apps/api/src/payouts/payouts.service.ts†L200-L320】
5. Successful donation callbacks now credit the creator wallet balance with the computed share and timestamp the `availableAt` field so downstream schedulers can pick up eligible funds. 【F:apps/api/src/donations/services/donation-callback.service.ts†L145-L208】
6. A dedicated BullMQ scheduler in the worker groups available donations into payout batches, reserves wallet balances atomically, and enqueues disbursement jobs. Each payout item stores the donation set, MSISDN, and wallet linkage for traceability. 【F:apps/worker/src/payouts/payout-scheduler.ts†L1-L210】【F:apps/api/src/payouts/schemas/payout-item.schema.ts†L1-L81】
7. The worker’s disbursement jobs invoke the Daraja B2C API, transition donation payout states to `processing`, and persist conversation IDs so the API can reconcile asynchronous callbacks. Failures keep funds in the wallet and mark the payout item for retry. 【F:apps/worker/src/payouts/payout-disburser.ts†L1-L128】【F:apps/api/src/mpesa/daraja.client.ts†L201-L277】
8. B2C result webhooks post back into the API where the payout disbursement service records ledger entries, clears pending wallet balances, updates donation payout states, and audits the event. 【F:apps/api/src/payouts/services/payout-disbursement.service.ts†L1-L274】【F:apps/api/src/webhooks/mpesa.controller.ts†L123-L212】

## 6. Observations and follow-up items
- **Schema mismatch:** `DonationSchema` currently marks `mpesaCheckoutRequestId` as required, yet `requestStkPush` creates documents before that field exists; ensure the schema allows null until Safaricom returns the ID or populate the field immediately to avoid validation failures. 【F:apps/api/src/donations/donation.schema.ts†L20-L59】【F:apps/api/src/donations/services/donation-requests.service.ts†L176-L236】
- **Statement reconciliation:** A dedicated worker queue now schedules `finance:reconcile` jobs that compare donation, payout, ledger, and imported M-Pesa statement totals on an hourly cadence and emits alerts when variances exceed the configured tolerance. The reconciliation task still assumes statement imports populate the `mpesa_transactions` collection; ensure imports run before the window closes. 【F:apps/worker/src/finance/reconciliation-job.ts†L1-L253】【F:apps/worker/src/index.ts†L52-L212】
- **Observability:** Donation callbacks, ledger postings, and admin queries are instrumented with OpenTelemetry spans, histograms, and structured logs so finance operators can audit the 70/30 split, ledger timings, and GraphQL usage. Finance alerts surface via the shared webhook dispatcher whenever reconciliation detects mismatches or payout jobs fail. 【F:apps/api/src/donations/services/donation-callback.service.ts†L1-L431】【F:apps/api/src/ledger/ledger.service.ts†L1-L260】【F:apps/worker/src/index.ts†L1-L240】
- **Regression safeguards:** Unit and smoke tests now cover the split math, ledger postings, admin resolvers, and dashboard hydration so future changes cannot regress the 70/30 computations or operator tooling without failing CI. 【F:apps/api/src/donations/services/donation-distribution.test.ts†L1-L60】【F:apps/api/src/ledger/ledger.service.test.ts†L1-L160】【F:apps/api/src/donations/donation.resolver.test.ts†L1-L140】【F:apps/web/src/app/admin/admin-smoke.test.tsx†L1-L86】
- **Backfill & rollout:** Use `pnpm --filter worker run backfill:donations --mode=shadow --limit=100` to dry-run the ledger backfill, `--mode=audit` to verify historical consistency, and `--apply` when ready to post missing journals and wallet credits. The worker script enforces the same distribution math and journal structure used during live callbacks. 【F:apps/worker/src/finance/backfill-donations.ts†L1-L321】【F:apps/worker/package.json†L1-L24】
- **Credential management:** Production deployments must provision `MPESA_WEBHOOK_PUBLIC_CERT` and KMS-backed credential keys so signature verification and OAuth encryption stay aligned with Safaricom requirements. 【F:apps/api/src/mpesa/daraja.client.ts†L68-L139】【F:apps/api/src/webhooks/mpesa-signature.service.ts†L21-L119】

Overall, the code path covers Daraja STK push best practices—validated inputs, credential hygiene, OAuth token caching, signed webhook enforcement, audit logs, and idempotent processing—and prepares downstream payout artefacts ready for the B2C disbursement job.
